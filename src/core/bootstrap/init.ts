/**
 * init.ts - Enhanced Application Initialization
 * V2 TypeScript - Proper V1 compatibility with view registry support
 * 
 * Initialize OneJS application with config from window.APP_CONFIGS
 * Handles:
 * 1. View registry loading (V2)
 * 2. Service initialization (Http, Store, Event)
 * 3. Router setup with routes
 * 4. View manager initialization
 * 5. App ready event dispatch
 */

import { Application } from "../app/Application.js";

/**
 * Initialize application from global config
 * Proper flow: Container â†’ Views â†’ Services â†’ Router â†’ Navigation
 */
export async function initApp(appInstance?: Application): Promise<void> {
    const app = appInstance || (typeof (window as any).App !== 'undefined' ? (window as any).App : null);
    
    if (!app) {
        console.error('âŒ No Application instance provided!');
        return;
    }

    const config = (window as any).APP_CONFIGS;
    if (!config) {
        console.error('âŒ APP_CONFIGS not found! Please define window.APP_CONFIGS.');
        return;
    }

    console.log('ğŸš€ OneJS V2 Application Initialization');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    try {
        // PHASE 1: Load view registry (V2 specific)
        await initializeViewRegistry(app);

        // PHASE 2: Initialize application core
        initializeApplication(app, config);

        // PHASE 3: Initialize services
        initializeServices(app, config);

        // PHASE 4: Setup router
        initializeRouter(app, config);

        // PHASE 5: Setup navigation
        initializeNavigation(app);

        // PHASE 6: Dispatch ready event
        dispatchAppReady(app, config);

        // PHASE 7: Setup view activation
        updateActiveNav(window.location.pathname);

        console.log('âœ… OneJS Application Initialized Successfully!');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    } catch (error) {
        console.error('âŒ Application initialization failed:', error);
        throw error;
    }
}

/**
 * PHASE 1: Initialize View Registry (V2)
 * Attempt to load pre-compiled view registry if available
 */
async function initializeViewRegistry(app: Application): Promise<void> {
    console.log('ğŸ“ Phase 1: Loading View Registry...');
    
    try {
        // Check if registry exists (generated by build system)
        const registryPath = './dist/v2/views-registry.js';
        try {
            const registryModule = await import(registryPath);
            const registry = registryModule.default || registryModule.ViewRegistry;
            
            if (registry && typeof registry === 'object') {
                app.View.setViewRegistry(registry);
                console.log(`   âœ“ View registry loaded: ${Object.keys(registry).length} views`);
                return;
            }
        } catch (registryError) {
            // Registry not available, fall back to runtime compilation
            console.log('   âš ï¸  Pre-compiled registry not found, will use runtime compilation');
        }
        
    } catch (error) {
        console.log('   âš ï¸  Registry initialization error:', (error as Error).message);
    }
    
    console.log('   âœ“ View registry phase completed\n');
}

/**
 * PHASE 2: Initialize Application Core
 */
function initializeApplication(_app: Application, config: any): void {
    console.log('ğŸ—ï¸  Phase 2: Application Core...');
    
    // Set container if specified
    if (config.container) {
        console.log(`   âœ“ Container: ${config.container}`);
    }
    
    // Initialize core components
    if (config.debug) {
        console.log('   âœ“ Debug mode enabled');
    }
    
    console.log('   âœ“ Application core initialized\n');
}

/**
 * PHASE 3: Initialize Services
 */
function initializeServices(app: Application, config: any): void {
    console.log('âš™ï¸  Phase 3: Services...');
    
    // Http Service
    if (app.Http && config.services?.http) {
        console.log('   âœ“ Http service configured');
    }
    
    // Store Service
    if (app.Store) {
        console.log('   âœ“ Store service initialized');
    }
    
    // Event Service
    if (app.Event) {
        console.log('   âœ“ Event service initialized');
    }
    
    console.log('   âœ“ Services initialized\n');
}

/**
 * PHASE 4: Initialize Router
 */
function initializeRouter(app: Application, config: any): void {
    console.log('ğŸ—ºï¸  Phase 4: Router...');
    
    if (!app.Router) {
        console.log('   âš ï¸  Router not available');
        return;
    }
    
    // Setup routes if provided
    if (config.routes && Array.isArray(config.routes)) {
        console.log(`   âœ“ Routes configured: ${config.routes.length} routes`);
    }
    
    console.log('   âœ“ Router initialized\n');
}

/**
 * PHASE 5: Initialize Navigation
 */
function initializeNavigation(app: Application): void {
    console.log('ğŸ§­ Phase 5: Navigation...');
    
    try {
        if (app.Router) {
            // Setup route change handler
            console.log('   âœ“ Route change handler set up');
        }
        
        console.log('   âœ“ Navigation initialized\n');
        
    } catch (error) {
        console.log('   âš ï¸  Navigation setup error:', (error as Error).message, '\n');
    }
}

/**
 * PHASE 6: Dispatch App Ready Event
 */
function dispatchAppReady(app: Application, config: any): void {
    console.log('ğŸ“¡ Phase 6: App Ready...');
    
    // Custom ready callback
    if (config.onReady && typeof config.onReady === 'function') {
        try {
            config.onReady(app);
            console.log('   âœ“ Custom ready callback executed');
        } catch (error) {
            console.log('   âš ï¸  Ready callback error:', (error as Error).message);
        }
    }
    
    // Dispatch global ready event
    if (typeof window !== 'undefined') {
        window.dispatchEvent(new CustomEvent('onejs:ready', { detail: { app } }));
        console.log('   âœ“ App ready event dispatched');
    }
    
    console.log('   âœ“ App ready phase completed\n');
}

/**
 * PHASE 7: Update Active Navigation
 */
export function updateActiveNav(currentPath?: string): void {
    console.log('ğŸ¯ Phase 7: Active Navigation...');
    
    const path = currentPath || window.location.pathname;
    
    // Update active nav classes
    document.querySelectorAll('[one-link]').forEach((link: Element) => {
        const href = link.getAttribute('one-link');
        const element = link as HTMLElement;
        
        if (href === path) {
            element.classList.add('active');
        } else {
            element.classList.remove('active');
        }
    });
    
    console.log(`   âœ“ Navigation updated for: ${path}\n`);
}

export default initApp;